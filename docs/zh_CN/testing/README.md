# 测试

本节介绍 PostgreSQL 后端的测试。

## 目录

- [测试配置](configuration.md): 测试环境设置
- [本地 PostgreSQL 测试](local.md): 本地数据库测试

## 提供者职责

作为后端实现，PostgreSQL 后端必须实现 Provider 接口来处理测试环境的设置和清理。这对于测试隔离和正确性至关重要。

### 关键原则

1. **环境准备**: 提供者必须：
   - 创建数据库 schema（表、索引、类型）
   - 建立数据库连接
   - 使用 PostgreSQL 特定实现配置测试模型

2. **环境清理**: 提供者必须：
   - 在每个测试后删除所有测试表
   - 删除自定义类型（如果有）
   - 正确关闭所有游标
   - 断开数据库连接

### 关键：清理顺序

清理必须按以下顺序进行以避免问题：

```
正确顺序：
1. DROP TABLE 语句（清理数据）
2. 删除自定义类型
3. 关闭游标
4. 断开连接

错误顺序：
1. 先断开连接  ❌
2. 然后清理  ❌ (连接已关闭！)
```

### 常见问题

- **表冲突**：不删除表可能导致"表已存在"错误
- **类型冲突**：PostgreSQL 自定义类型（如 ENUM、ARRAY）需要删除
- **数据污染**：不清理可能导致上下文相关测试失败
- **连接问题**：不当清理可能导致资源耗尽

### 实现参考

详细实现指南请参阅测试套件文档：
- `python-activerecord-testsuite/docs/zh_CN/README.md`
